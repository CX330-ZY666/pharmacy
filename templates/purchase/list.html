{% extends "base.html" %}
{% block title %}è¿›è´§ç®¡ç†{% endblock %}

{% block content %}
<div class="main-container">
    <h2>ğŸ›’ è¿›è´§ç®¡ç†</h2>
    <a href="/purchase/add" class="btn btn-success mb-3">+ æ–°å¢é‡‡è´­å•</a>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- é‡‡è´­å•åˆ—è¡¨ -->
    <div class="card">
        <table class="table table-hover">
            <thead class="thead-light">
                <tr>
                    <th>é‡‡è´­å•å·</th>
                    <th>é‡‡è´­æ—¥æœŸ</th>
                    <th>ä¾›åº”å•†</th>
                    <th>æ€»é‡‘é¢</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="purchaseTableBody">
                {% if purchases %}
                {% for purchase in purchases %}
                <tr>
                    <td>#{{ purchase.purchase_id }}</td>
                    <td>{{ purchase.purchase_date }}</td>
                    <td>{{ purchase.supplier_name }}</td>
                    <td>Â¥{{ "%.2f"|format(purchase.total_amount) }}</td>
                    <td>
                        <button class="btn btn-primary btn-sm view-detail-btn"
                            data-purchase-id="{{ purchase.purchase_id }}">
                            æŸ¥çœ‹
                        </button>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="5" class="text-center text-muted">æš‚æ— é‡‡è´­å•</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal"
        style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
        <div class="modal-content"
            style="background-color:#fefefe; margin:5% auto; padding:20px; border:1px solid #888; width:80%; max-width:800px; border-radius:8px;">
            <div class="modal-header"
                style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:15px;">
                <h3>é‡‡è´­å•è¯¦æƒ… #<span id="modalPurchaseId"></span></h3>
                <span class="close-btn" style="font-size:28px; cursor:pointer; color:#999;"
                    onclick="closeDetailModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding:20px 0; max-height:60vh; overflow-y:auto;">
                <div style="margin-bottom:20px;">
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin-bottom:15px;">
                        <div>
                            <strong>ä¾›åº”å•†:</strong> <span id="modalSupplier"></span>
                        </div>
                        <div>
                            <strong>é‡‡è´­æ—¥æœŸ:</strong> <span id="modalDate"></span>
                        </div>
                        <div>
                            <strong>æ€»é‡‘é¢:</strong> <span id="modalAmount"></span>
                        </div>
                        <div>
                            <strong>å¤‡æ³¨:</strong> <span id="modalNote"></span>
                        </div>
                    </div>
                </div>

                <h4>é‡‡è´­æ˜ç»†</h4>
                <table style="width:100%; border-collapse:collapse; margin-top:10px;">
                    <thead style="background-color:#f8f9fa;">
                        <tr>
                            <th style="padding:10px; border-bottom:2px solid #dee2e6;">è¯å“åç§°</th>
                            <th style="padding:10px; border-bottom:2px solid #dee2e6;">æ‰¹æ¬¡å·</th>
                            <th style="padding:10px; border-bottom:2px solid #dee2e6;">æ•°é‡</th>
                            <th style="padding:10px; border-bottom:2px solid #dee2e6;">å•ä»·</th>
                            <th style="padding:10px; border-bottom:2px solid #dee2e6;">æœ‰æ•ˆæœŸ</th>
                            <th style="padding:10px; border-bottom:2px solid #dee2e6;">å°è®¡</th>
                        </tr>
                    </thead>
                    <tbody id="modalDetails">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer" style="text-align:right; border-top:1px solid #eee; padding-top:15px;">
                <button class="btn btn-secondary" onclick="closeDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    
</div>

<script>
    // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', function () {
        // ç»‘å®šæŸ¥çœ‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
        document.getElementById('purchaseTableBody').addEventListener('click', function (event) {
            if (event.target.classList.contains('view-detail-btn')) {
                const purchaseId = event.target.getAttribute('data-purchase-id');
                if (purchaseId) {
                    showPurchaseDetail(purchaseId);
                }
            }
        });

        // ç»‘å®šæ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­
        const modal = document.getElementById('detailModal');
        if (modal) {
            modal.addEventListener('click', function (event) {
                if (event.target === modal) {
                    closeDetailModal();
                }
            });
        }
    });

    // æ˜¾ç¤ºé‡‡è´­å•è¯¦æƒ…
    async function showPurchaseDetail(purchaseId) {
        try {
            console.log('æ­£åœ¨è·å–é‡‡è´­å•è¯¦æƒ…ï¼ŒID:', purchaseId);

            // è®¾ç½®åŸºæœ¬ä¿¡æ¯
            document.getElementById('modalPurchaseId').textContent = purchaseId;

            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹ï¼Œæ˜¾ç¤ºåŠ è½½ä¸­
            document.getElementById('modalDetails').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">åŠ è½½ä¸­...</td></tr>';

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('detailModal').style.display = 'block';

            // å‘é€è¯·æ±‚è·å–è¯¦æƒ…
            const response = await fetch(`/purchase/${purchaseId}`);

            // æ£€æŸ¥å“åº”çŠ¶æ€
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
            }

            // è§£æå“åº”æ•°æ®
            const result = await response.json();

            // æ£€æŸ¥åç«¯è¿”å›çš„successå­—æ®µ
            if (!result.success) {
                throw new Error(result.message || 'è·å–è¯¦æƒ…å¤±è´¥');
            }

            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            const purchase = result.purchase;
            const details = result.details || [];

            document.getElementById('modalSupplier').textContent = purchase.supplier_name || 'æœªçŸ¥';
            document.getElementById('modalDate').textContent = purchase.purchase_date || 'æœªçŸ¥';

            // å®‰å…¨åœ°å¤„ç†æ€»é‡‘é¢ï¼ˆå¯èƒ½ä¸ºnullæˆ–undefinedï¼‰
            let totalAmount = 0;
            if (purchase.total_amount) {
                // ç¡®ä¿æ˜¯æ•°å­—ç±»å‹
                totalAmount = parseFloat(purchase.total_amount);
                if (isNaN(totalAmount)) {
                    totalAmount = 0;
                }
            }
            document.getElementById('modalAmount').textContent = 'Â¥' + totalAmount.toFixed(2);

            document.getElementById('modalNote').textContent = purchase.note || 'æ— ';

            // æ›´æ–°æ˜ç»†è¡¨æ ¼
            const detailsBody = document.getElementById('modalDetails');
            detailsBody.innerHTML = '';

            if (details.length > 0) {
                details.forEach(detail => {
                    // å®‰å…¨å¤„ç†æ•°å€¼å­—æ®µ
                    const quantity = detail.quantity ? parseFloat(detail.quantity) : 0;
                    const price = detail.price ? parseFloat(detail.price) : 0;
                    const subtotal = quantity * price;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td style="padding:10px;border-bottom:1px solid #eee;">${detail.drug_name || 'æœªçŸ¥'}</td>
                    <td style="padding:10px;border-bottom:1px solid #eee;">${detail.batch_no || 'æœªçŸ¥'}</td>
                    <td style="padding:10px;border-bottom:1px solid #eee;">${quantity}</td>
                    <td style="padding:10px;border-bottom:1px solid #eee;">Â¥${price.toFixed(2)}</td>
                    <td style="padding:10px;border-bottom:1px solid #eee;">${detail.expiry_date || 'æœªçŸ¥'}</td>
                    <td style="padding:10px;border-bottom:1px solid #eee;">Â¥${subtotal.toFixed(2)}</td>
                `;
                    detailsBody.appendChild(row);
                });
            } else {
                detailsBody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;">æš‚æ— é‡‡è´­æ˜ç»†</td></tr>';
            }

        } catch (error) {
            console.error('è·å–è¯¦æƒ…å¤±è´¥:', error);

            // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            const detailsBody = document.getElementById('modalDetails');
            detailsBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align:center;padding:20px;color:red;">
                    è¯·æ±‚å¤±è´¥ï¼š${error.message}<br>
                    è¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯
                </td>
            </tr>
        `;
        }
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeDetailModal() {
        document.getElementById('detailModal').style.display = 'none';
    }

    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeDetailModal();
        }
    });
</script>

<style>
    .main-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
    }

    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }

    .close-btn:hover {
        color: #333;
    }
</style>
{% endblock %}