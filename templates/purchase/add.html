{% extends "base.html" %}
{% block title %}æ–°å¢é‡‡è´­å•{% endblock %}

{% block content %}
<div class="main-container">
    <div class="page-header">
        <h2>ğŸ›’ æ–°å¢é‡‡è´­å•</h2>
        <div class="dev-tag">æ­¤é¡µé¢ç”±æˆå‘˜Cè´Ÿè´£å¼€å‘</div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('purchase.purchase_add') }}" class="card form-card">
        <div class="form-group">
            <label for="supplier_id" class="form-label">ä¾›åº”å•†</label>
            <select name="supplier_id" id="supplier_id" class="form-control" required>
                <option value="">è¯·é€‰æ‹©ä¾›åº”å•†</option>
                {% for supplier in suppliers %}
                <option value="{{ supplier.supplier_id }}">{{ supplier.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="purchase_date" class="form-label">é‡‡è´­æ—¥æœŸ</label>
            <input type="date" name="purchase_date" id="purchase_date" class="form-control" required>
        </div>

        <div class="form-group">
            <label class="form-label">é‡‡è´­æ˜ç»†</label>
            <table id="details-table" class="data-table">
                <thead>
                    <tr>
                        <th>è¯å“åç§°</th>
                        <th>æ‰¹æ¬¡å·</th>
                        <th>æ•°é‡</th>
                        <th>å•ä»·(å…ƒ)</th>
                        <th>æœ‰æ•ˆæœŸ</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <select name="drug_id[]" class="form-control" required>
                                <option value="">è¯·é€‰æ‹©è¯å“</option>
                                {% for drug in drugs %}
                                <option value="{{ drug.drug_id }}">{{ drug.name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td><input type="text" name="batch_no[]" class="form-control" required></td>
                        <td><input type="number" name="quantity[]" class="form-control" min="1" required></td>
                        <td><input type="number" name="price[]" class="form-control" step="0.01" min="0" required></td>
                        <td><input type="date" name="expiry_date[]" class="form-control" required></td>
                        <td>
                            <button type="button" class="btn-danger" onclick="this.closest('tr').remove()">åˆ é™¤</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn-secondary" onclick="addDetailRow()" style="margin-top: 10px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14" />
                </svg>
                æ·»åŠ æ˜ç»†è¡Œ
            </button>
        </div>

        <div class="form-group">
            <label for="note" class="form-label">å¤‡æ³¨</label>
            <textarea name="note" id="note" class="form-control" rows="3"></textarea>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">æäº¤é‡‡è´­å•</button>
            <a href="{{ url_for('purchase.purchase_list') }}" class="btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<script>
    function addDetailRow() {
        const table = document.getElementById('details-table');
        const newRow = table.insertRow();
        newRow.innerHTML = `
            <td>
                <select name="drug_id[]" class="form-control" required>
                    <option value="">è¯·é€‰æ‹©è¯å“</option>
                    {% for drug in drugs %}
                    <option value="{{ drug.drug_id }}">{{ drug.name }}</option>
                    {% endfor %}
                </select>
            </td>
            <td><input type="text" name="batch_no[]" class="form-control" required></td>
            <td><input type="number" name="quantity[]" class="form-control" min="1" required></td>
            <td><input type="number" name="price[]" class="form-control" step="0.01" min="0" required></td>
            <td><input type="date" name="expiry_date[]" class="form-control" required></td>
            <td>
                <button type="button" class="btn-danger" onclick="this.closest('tr').remove()">åˆ é™¤</button>
            </td>
        `;
    }
</script>
{% endblock %}