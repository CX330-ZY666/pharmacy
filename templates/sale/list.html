{% extends "base.html" %}
{% block title %}é”€å”®ç®¡ç†{% endblock %}

{% block content %}
<div class="main-container">
    <h2>ğŸ’° é”€å”®ç®¡ç†</h2>
    <a href="{{ url_for('sale.sale_add') }}" class="btn btn-success mb-3">+ æ–°å¢é”€å”®å•</a>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- é”€å”®å•åˆ—è¡¨ -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 70px;">åºå·</th>
                            <th style="width: 120px;">é”€å”®å•å·</th>
                            <th style="width: 110px;">é”€å”®æ—¥æœŸ</th>
                            <th style="min-width: 150px;">å®¢æˆ·</th>
                            <th style="width: 120px; text-align: right; padding-right: 20px;">æ€»é‡‘é¢</th>
                            <th class="text-center" style="width: 100px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if sales %}
                        {% for sale in sales %}
                        <tr>
                            <td class="text-center">{{ sale.reverse_index }}</td>
                            <td>SALE-{{ "%04d"|format(sale.sale_id) }}</td>
                            <td>{{ sale.sale_date }}</td>
                            <td>{{ sale.customer_name }}</td>
                            <td style="text-align: right; padding-right: 20px;">
                                <span class="text-success fw-bold">Â¥{{ "%.2f"|format(sale.total_amount) }}</span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-primary btn-sm view-detail-btn"
                                    data-sale-id="{{ sale.sale_id }}">
                                    æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">æš‚æ— é”€å”®è®°å½•</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- æ·»åŠ åˆ†é¡µä¿¡æ¯ -->
            {% if sales %}
            <div class="mt-3 text-muted text-end">
                <small>å…± {{ total_count }} æ¡è®°å½•</small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">é”€å”®å•è¯¦æƒ… #<span id="modalSaleNo"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modal-body">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½è¯¦æƒ…...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ä½¿ç”¨Bootstrap 5çš„æ¨¡æ€æ¡†
    document.addEventListener('DOMContentLoaded', function () {
        // ç»‘å®šæŸ¥çœ‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.addEventListener('click', function (event) {
            if (event.target && event.target.classList.contains('view-detail-btn')) {
                const saleId = event.target.getAttribute('data-sale-id');
                if (saleId) {
                    showSaleDetail(saleId);
                }
            }
        });
    });

    // æ˜¾ç¤ºé”€å”®å•è¯¦æƒ…
    async function showSaleDetail(saleId) {
        try {
            console.log('æ­£åœ¨è·å–é”€å”®å•è¯¦æƒ…ï¼ŒID:', saleId);

            // è®¾ç½®é”€å”®å•å·
            const saleNo = 'SALE-' + String(saleId).padStart(4, '0');
            document.getElementById('modalSaleNo').textContent = saleNo;

            // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
            document.getElementById('modal-body').innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-2">æ­£åœ¨åŠ è½½è¯¦æƒ…...</p>
            </div>
        `;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            detailModal.show();

            // å‘é€è¯·æ±‚è·å–è¯¦æƒ…
            const response = await fetch(`/sale/${saleId}`);

            // æ£€æŸ¥å“åº”çŠ¶æ€
            if (!response.ok) {
                throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
            }

            // è§£æå“åº”æ•°æ®
            const result = await response.json();

            // æ£€æŸ¥åç«¯è¿”å›çš„successå­—æ®µ
            if (!result.success) {
                throw new Error(result.message || 'è·å–è¯¦æƒ…å¤±è´¥');
            }

            // æ›´æ–°æ¨¡æ€æ¡†å†…å®¹
            const sale = result.sale;
            const details = result.details || [];

            let html = `
            <div class="mb-3">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>é”€å”®å•å·:</strong> SALE-${sale.sale_id.toString().padStart(4, '0')}</p>
                        <p><strong>å®¢æˆ·:</strong> ${sale.customer_name || 'æœªçŸ¥'}</p>
        `;

            // æ·»åŠ è”ç³»æ–¹å¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const contactFields = ['phone', 'tel', 'mobile', 'contact_info'];
            let hasContact = false;
            contactFields.forEach(field => {
                if (sale[field]) {
                    html += `<p><strong>${field === 'mobile' ? 'æ‰‹æœº' : 'ç”µè¯'}:</strong> ${sale[field]}</p>`;
                    hasContact = true;
                }
            });

            if (!hasContact) {
                html += `<p><strong>ç”µè¯:</strong> æœªå¡«å†™</p>`;
            }

            html += `
                    </div>
                    <div class="col-md-6">
                        <p><strong>é”€å”®æ—¥æœŸ:</strong> ${sale.sale_date || 'æœªçŸ¥'}</p>
                        <p><strong>åœ°å€:</strong> ${sale.address || 'æœªå¡«å†™'}</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-success">
                            <h5 class="mb-0"><strong>æ€»é‡‘é¢:</strong> Â¥${sale.total_amount ? parseFloat(sale.total_amount).toFixed(2) : '0.00'}</h5>
                        </div>
                    </div>
                </div>
            </div>
            
            <h5>é”€å”®æ˜ç»†</h5>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 60px;">åºå·</th>
                            <th style="min-width: 150px;">è¯å“åç§°</th>
                            <th style="width: 120px;">æ‰¹æ¬¡å·</th>
                            <th class="text-end" style="width: 80px;">æ•°é‡</th>
                            <th class="text-end" style="width: 100px;">å•ä»·</th>
                            <th class="text-end" style="width: 120px;">å°è®¡</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

            if (details && details.length > 0) {
                let totalSubtotal = 0;
                details.forEach((detail, index) => {
                    const quantity = detail.quantity || 0;
                    const price = detail.price || 0;
                    const subtotal = quantity * price;
                    totalSubtotal += subtotal;

                    html += `
                    <tr>
                        <td class="text-center">${index + 1}</td>
                        <td>${detail.drug_name || 'æœªçŸ¥'}</td>
                        <td>${detail.batch_no || 'æœªçŸ¥'}</td>
                        <td class="text-end">${quantity}</td>
                        <td class="text-end">Â¥${price.toFixed(2)}</td>
                        <td class="text-end">Â¥${subtotal.toFixed(2)}</td>
                    </tr>
                `;
                });

                html += `
                    </tbody>
                    <tfoot>
                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                            <td colspan="5" class="text-end">æ€»è®¡ï¼š</td>
                            <td class="text-end">Â¥${totalSubtotal.toFixed(2)}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            `;
            } else {
                html += `
                    <tr>
                        <td colspan="6" class="text-center">æš‚æ— é”€å”®æ˜ç»†</td>
                    </tr>
                </tbody>
            </table>
        </div>
            `;
            }

            document.getElementById('modal-body').innerHTML = html;

        } catch (error) {
            console.error('è·å–è¯¦æƒ…å¤±è´¥:', error);

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            document.getElementById('modal-body').innerHTML = `
            <div class="alert alert-danger">
                <h6>è¯·æ±‚å¤±è´¥</h6>
                <p>${error.message}</p>
                <p class="mb-0">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚</p>
            </div>
        `;
        }
    }
</script>

<style>
    .main-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
    }

    /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
    .table {
        margin-bottom: 0;
    }

    .table th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
    }

    .table td {
        vertical-align: middle;
        border-color: #e9ecef;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.02);
    }

    /* å¯¹é½ä¼˜åŒ– */
    .table th.text-end,
    .table td.text-end {
        text-align: right !important;
        padding-right: 20px !important;
    }

    .table th.text-center,
    .table td.text-center {
        text-align: center !important;
    }

    /* æ“ä½œæŒ‰é’®æ ·å¼ */
    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .btn-primary:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }

    /* é‡‘é¢æ ·å¼ */
    .text-success {
        color: #28a745 !important;
        font-weight: 600;
    }

    /* æ¨¡æ€æ¡†è¡¨æ ¼å¯¹é½ */
    .modal-body .table th.text-end,
    .modal-body .table td.text-end {
        text-align: right !important;
        padding-right: 15px !important;
    }

    .modal-body .table th.text-center,
    .modal-body .table td.text-center {
        text-align: center !important;
    }
</style>
{% endblock %}