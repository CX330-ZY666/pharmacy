{% extends "base.html" %}
{% block title %}æ–°å¢é”€å”®å•{% endblock %}

{% block content %}
<div class="main-container">
    <div class="page-header">
        <h2>ğŸ’° æ–°å¢é”€å”®å•</h2>
        <div class="dev-tag">æ­¤é¡µé¢ç”±æˆå‘˜Cè´Ÿè´£å¼€å‘</div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('sale.sale_add') }}" class="card form-card" id="sale-form">
        <div class="form-group">
            <label for="customer_id" class="form-label">å®¢æˆ·</label>
            <select name="customer_id" id="customer_id" class="form-control" required>
                <option value="">è¯·é€‰æ‹©å®¢æˆ·</option>
                {% for customer in customers %}
                <option value="{{ customer.customer_id }}">{{ customer.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="sale_date" class="form-label">é”€å”®æ—¥æœŸ</label>
            <input type="date" name="sale_date" id="sale_date" class="form-control" value="{{ now_date }}" required>
        </div>

        <div class="form-group">
            <label class="form-label">é”€å”®æ˜ç»†</label>
            <table id="details-table" class="data-table">
                <thead>
                    <tr>
                        <th>è¯å“åç§°</th>
                        <th>æ‰¹æ¬¡å·</th>
                        <th>æ•°é‡</th>
                        <th>å•ä»·(å…ƒ)</th>
                        <th>å°è®¡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="details-tbody">
                    <tr class="detail-row">
                        <td>
                            <select name="drug_id[]" class="form-control drug-select" required>
                                <option value="">è¯·é€‰æ‹©è¯å“</option>
                                {% for item in inventory %}
                                <option value="{{ item.drug_id }}">{{ item.name }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select name="batch_no[]" class="form-control batch-select" required disabled>
                                <option value="">è¯·å…ˆé€‰æ‹©è¯å“</option>
                            </select>
                        </td>
                        <td><input type="number" name="quantity[]" class="form-control quantity" min="1" required></td>
                        <td><input type="number" name="price[]" class="form-control price" step="0.01" min="0.01"
                                required></td>
                        <td class="subtotal">0.00</td>
                        <td>
                            <button type="button" class="btn-danger remove-row-btn">åˆ é™¤</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="btn-secondary" id="add-row-btn" style="margin-top: 10px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14" />
                </svg>
                æ·»åŠ æ˜ç»†è¡Œ
            </button>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary">æäº¤é”€å”®å•</button>
            <a href="{{ url_for('sale.sale_list') }}" class="btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>
</div>

<script>
    // åº“å­˜æ•°æ®ï¼ˆä»åç«¯ä¼ é€’ï¼‰
    const inventoryData = JSON.parse('{{ inventory_json|safe }}');

    // å°†åº“å­˜æ•°æ®è½¬æ¢ä¸ºè¯å“IDä¸ºé”®çš„æ˜ å°„
    const inventoryMap = {};
    inventoryData.forEach(item => {
        inventoryMap[item.drug_id] = item;
    });

    // æ›´æ–°æ‰¹æ¬¡ä¸‹æ‹‰æ¡†
    function updateBatchSelect(drugId, batchSelect) {
        batchSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æ‰¹æ¬¡</option>';

        if (drugId && inventoryMap[drugId]) {
            const batches = inventoryMap[drugId].batches;
            batches.forEach(batch => {
                const option = document.createElement('option');
                option.value = batch.batch_no;
                option.textContent = `${batch.batch_no} (åº“å­˜: ${batch.quantity})`;
                batchSelect.appendChild(option);
            });
            batchSelect.disabled = false;
        } else {
            batchSelect.disabled = true;
        }
    }

    // è®¡ç®—å°è®¡å’Œæ€»è®¡
    function calculateSubtotal(row) {
        const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
        const price = parseFloat(row.querySelector('.price').value) || 0;
        const subtotal = quantity * price;
        row.querySelector('.subtotal').textContent = subtotal.toFixed(2);
    }

    // æ·»åŠ æ–°è¡Œ
    document.getElementById('add-row-btn').addEventListener('click', function () {
        const tbody = document.getElementById('details-tbody');
        const newRow = document.createElement('tr');
        newRow.className = 'detail-row';

        // ç”Ÿæˆè¯å“é€‰é¡¹HTML
        let drugOptions = '<option value="">è¯·é€‰æ‹©è¯å“</option>';
        for (const drugId in inventoryMap) {
            const item = inventoryMap[drugId];
            drugOptions += `<option value="${drugId}">${item.name}</option>`;
        }

        newRow.innerHTML = `
            <td>
                <select name="drug_id[]" class="form-control drug-select" required>
                    ${drugOptions}
                </select>
            </td>
            <td>
                <select name="batch_no[]" class="form-control batch-select" required disabled>
                    <option value="">è¯·å…ˆé€‰æ‹©è¯å“</option>
                </select>
            </td>
            <td><input type="number" name="quantity[]" class="form-control quantity" min="1" required></td>
            <td><input type="number" name="price[]" class="form-control price" step="0.01" min="0.01" required></td>
            <td class="subtotal">0.00</td>
            <td>
                <button type="button" class="btn-danger remove-row-btn">åˆ é™¤</button>
            </td>
        `;

        tbody.appendChild(newRow);

        // ä¸ºæ–°è¡Œçš„è¯å“é€‰æ‹©æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
        const newDrugSelect = newRow.querySelector('.drug-select');
        newDrugSelect.addEventListener('change', function () {
            const batchSelect = this.closest('.detail-row').querySelector('.batch-select');
            updateBatchSelect(this.value, batchSelect);
        });

        // ä¸ºæ–°è¡Œçš„æ•°é‡/å•ä»·è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
        newRow.querySelector('.quantity').addEventListener('input', function () {
            calculateSubtotal(this.closest('.detail-row'));
        });

        newRow.querySelector('.price').addEventListener('input', function () {
            calculateSubtotal(this.closest('.detail-row'));
        });
    });

    // åˆ é™¤è¡Œ
    document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('remove-row-btn')) {
            const row = e.target.closest('.detail-row');
            const allRows = document.querySelectorAll('.detail-row');
            if (allRows.length > 1) {
                row.remove();
            }
        }
    });

    // ä¸ºç°æœ‰çš„è¯å“é€‰æ‹©æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
    document.querySelectorAll('.drug-select').forEach(select => {
        select.addEventListener('change', function () {
            const batchSelect = this.closest('.detail-row').querySelector('.batch-select');
            updateBatchSelect(this.value, batchSelect);
        });
    });

    // ä¸ºç°æœ‰çš„æ•°é‡/å•ä»·è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
    document.querySelectorAll('.quantity').forEach(input => {
        input.addEventListener('input', function () {
            calculateSubtotal(this.closest('.detail-row'));
        });
    });

    document.querySelectorAll('.price').forEach(input => {
        input.addEventListener('input', function () {
            calculateSubtotal(this.closest('.detail-row'));
        });
    });

    // è¡¨å•æäº¤éªŒè¯
    document.getElementById('sale-form').addEventListener('submit', function (e) {
        const batchSelects = document.querySelectorAll('.batch-select');
        let isValid = true;

        // éªŒè¯æ‰€æœ‰è¯å“å’Œæ‰¹æ¬¡éƒ½å·²é€‰æ‹©
        batchSelects.forEach(select => {
            if (!select.value || select.disabled) {
                alert('è¯·ä¸ºæ‰€æœ‰è¯å“é€‰æ‹©æ‰¹æ¬¡');
                isValid = false;
            }
        });

        if (!isValid) {
            e.preventDefault();
        }
    });
</script>
{% endblock %}